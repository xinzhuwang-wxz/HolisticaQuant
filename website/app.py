# æ–‡ä»¶: app.py (å‰ç«¯ - çœŸå®APIè°ƒç”¨ç‰ˆ - 2025/11/08 æ›´æ–°)
import streamlit as st
import time
import pandas as pd
import matplotlib.pyplot as plt
import numpy as np
import re
import random
import requests  # <-- â€¼ï¸ å¿…é¡»å¯¼å…¥è¿™ä¸ªæ–°åŒ…

# -----------------------------------------------------------------
# é¡µé¢é…ç½® (Page Config)
# -----------------------------------------------------------------
# è®¾ç½®é¡µé¢æ ‡é¢˜ã€å›¾æ ‡å’Œå¸ƒå±€
st.set_page_config(
    page_title="Holistica Quant",
    page_icon="ğŸ¤–",
    layout="wide"
)


# -----------------------------------------------------------------
# â€¼ï¸â€¼ï¸ã€çœŸå®ç‰ˆã€‘åç«¯APIè°ƒç”¨ â€¼ï¸â€¼ï¸
# -----------------------------------------------------------------
def call_holistica_backend(query: str):
    """
    ã€çœŸå®ç‰ˆã€‘
    è°ƒç”¨åœ¨ http://127.0.0.1:8000 è¿è¡Œçš„ FastAPI åç«¯ã€‚
    """

    # ä½ çš„FastAPIåç«¯è¿è¡Œçš„åœ°å€ (main.py è¿è¡Œçš„åœ°æ–¹)
    BACKEND_URL = "http://127.0.0.1:8000/analyze"

    with st.spinner(f"ğŸ¤– Holistica Agent æ­£åœ¨åˆ†æä¸­... (æ­£åœ¨è°ƒç”¨çœŸå®åç«¯)"):
        try:
            # 1. å°†ç”¨æˆ·çš„æé—®ä½œä¸ºJSONå‘é€åˆ°åç«¯
            # è®¾ç½®ä¸€ä¸ªè¶…æ—¶æ—¶é—´ï¼ˆä¾‹å¦‚30ç§’ï¼‰
            response = requests.post(BACKEND_URL, json={"query": query}, timeout=30)

            # 2. æ£€æŸ¥åç«¯æ˜¯å¦æˆåŠŸ
            if response.status_code == 200:
                # 3. ä»åç«¯è·å–JSONå“åº”å¹¶è¿”å›
                # å®ƒçš„ç»“æ„æ˜¯ {"report": "...", "data": {...}}
                return response.json()
            else:
                # å¦‚æœåç«¯å‡ºé”™ (æ¯”å¦‚500é”™è¯¯)
                st.error(f"åç«¯APIé”™è¯¯ (çŠ¶æ€ç : {response.status_code})")
                st.error(f"é”™è¯¯è¯¦æƒ…: {response.text}")
                return {"report": "åç«¯åˆ†æå¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡å™¨ã€‚", "data": {}}

        except requests.exceptions.ConnectionError:
            # å¦‚æœåç«¯æœåŠ¡å™¨æ²¡æœ‰è¿è¡Œ
            st.error("âŒ æ— æ³•è¿æ¥åˆ°åç«¯æœåŠ¡å™¨ï¼")
            st.error("è¯·ç¡®è®¤ä½ çš„FastAPIåç«¯æ­£åœ¨ http://127.0.0.1:8000 è¿è¡Œã€‚")
            st.info(
                "å¦‚ä½•è¿è¡Œåç«¯ï¼š\n 1. æ‰“å¼€ä¸€ä¸ªæ–°çš„ç»ˆç«¯ \n 2. `cd backend` \n 3. `pip install -r requirements_be.txt` \n 4. `uvicorn main:app --reload`")
            return {"report": "è¿æ¥å¤±è´¥ã€‚", "data": {}}
        except requests.exceptions.Timeout:
            st.error("âŒ åç«¯è¯·æ±‚è¶…æ—¶ï¼")
            st.error("åç«¯åˆ†ææ—¶é—´è¿‡é•¿ï¼Œå·²ä¸­æ–­ã€‚è¯·æ£€æŸ¥åç«¯é€»è¾‘æˆ–å»¶é•¿è¶…æ—¶æ—¶é—´ã€‚")
            return {"report": "è¯·æ±‚è¶…æ—¶ã€‚", "data": {}}


# -----------------------------------------------------------------
# ä¾§è¾¹æ å¯¼èˆª (Sidebar Navigation)
# -----------------------------------------------------------------
st.sidebar.title("ğŸ¤– Holistica Quant")
st.sidebar.markdown("---")
page = st.sidebar.radio(
    "åŠŸèƒ½æ¨¡å— (Modules)",
    [
        "æ¬¢è¿ (Welcome)",
        "æ¨¡å—ä¸€ï¼šé‡‘èç§‘æŠ€å­¦ä¹  (FinTech Learning)",
        "æ¨¡å—äºŒï¼šæŠ•ç ”å®éªŒå®¤ (Investment Lab)",
        "æ¨¡å—ä¸‰ï¼šAIä¼´éšåˆ†æ (AI Companion)",
        "æ¨¡å—å››ï¼šå…¨çƒè¶‹åŠ¿ä¸æ–°é—» (News & Trends)"
    ],
    captions=[
        "é¡¹ç›®ä»‹ç»",
        "AIäº’åŠ¨è®²å¸ˆ",
        "è™šæ‹ŸæŠ•èµ„ä¸å›æµ‹",
        "è‡ªç„¶è¯­è¨€é©±åŠ¨åˆ†æ",
        "è´¢æŠ¥ä¸é»‘å¤©é¹…è¿½è¸ª"
    ]
)
st.sidebar.markdown("---")
st.sidebar.info("å¾®ä¼—é“¶è¡Œé‡‘èç§‘æŠ€å¤§èµ›")

# -----------------------------------------------------------------
# é¡µé¢å†…å®¹ (Page Content)
# -----------------------------------------------------------------

# ----------------- æ¬¢è¿ (Welcome) -----------------
if page == "æ¬¢è¿ (Welcome)":
    st.title("æ¬¢è¿æ¥åˆ° Holistica Quant ğŸ¤–")
    st.subheader("ä¸€ä¸ªç«¯åˆ°ç«¯çš„AIé©±åŠ¨çš„æ·±åº¦æ´è§ä¸ç ”ç©¶åˆ†æ | è™šæ‹Ÿé‡åŒ–æŠ•èµ„å®éªŒå®¤")
    st.caption("Al-powered Insight Investment Lab")

    st.markdown("---")

    # æ ¹æ® TPRD.pdf çš„å†…å®¹æ›´æ–°
    st.subheader("ğŸ¯ äº§å“å®šä½ä¸æ ¸å¿ƒä»·å€¼")
    st.markdown("""
    æˆ‘ä»¬æ˜¯ä¸€ä¸ªé¢å‘é‡‘èæœºæ„ä¸é«˜æ ¡çš„AIé‡‘èæ•™è‚²æŠ€æœ¯è§£å†³æ–¹æ¡ˆã€‚

    * **æ ¸å¿ƒä»·å€¼:** é™ä½é‡‘èç§‘æŠ€å­¦ä¹ é—¨æ§›ï¼Œæä¾›AIåŸç”Ÿçš„æ™ºèƒ½é‡‘èå­¦ä¹ ä¸å®è·µå¹³å°ã€‚
    * **å¸‚åœºä»·å€¼:** ä¸ºå¾®ä¼—é“¶è¡Œæä¾›ä¸€ä¸ªâ€œAIäººæ‰å­µåŒ–+åˆ›æ–°å®éªŒå¹³å°â€ã€‚
    """)

    # æ ¹æ® TEAM.pdf çš„å†…å®¹æ›´æ–°
    st.subheader("ğŸ‘¥ å›¢é˜Ÿæˆå‘˜")
    st.markdown("""
    * **äº§å“ (Product):** Caroline, Iris
    * **ç ”å‘ (R&D):** Jess, Jacky
    * **è¾…åŠ© (Support):** Maxen
    """)

    st.markdown("---")

    # è§£å†³çš„ç—›ç‚¹
    st.subheader("ğŸ“Œ è§£å†³çš„ç—›ç‚¹")
    st.markdown("""
    1.  **é‡‘èå­¦ä¹ é—¨æ§›é«˜:** é‡‘èçŸ¥è¯†ä½“ç³»åºå¤§ã€æ•°æ®å’Œå·¥å…·ç¢ç‰‡åŒ–ã€‚
    2.  **äº§å­¦ç ”è„±èŠ‚:** é«˜æ ¡è¯¾ç¨‹ä¸è¡Œä¸šä¼ä¸šç¼ºä¹å®è·µé¡¹ç›®ï¼Œæ•™è‚²ä¸å®è·µè„±èŠ‚ã€‚
    3.  **æ¯•ä¸šç”ŸæŠ€èƒ½è„±èŠ‚:** ç¼ºä¹â€œé¡¹ç›®å¼å®æ“ç»éªŒâ€ï¼Œç†è®ºä¸å®é™…å·®è·å¤§ã€‚
    """)

    st.info("åç«¯æœåŠ¡å™¨ (FastAPI) çŠ¶æ€ï¼šè¯·åœ¨â€œæ¨¡å—ä¸‰â€ä¸­æµ‹è¯•APIè¿æ¥ã€‚")

# ----------------- æ¨¡å—ä¸€ï¼šé‡‘èç§‘æŠ€å­¦ä¹  -----------------
elif page == "æ¨¡å—ä¸€ï¼šé‡‘èç§‘æŠ€å­¦ä¹  (FinTech Learning)":
    st.title("ğŸ“š æ¨¡å—ä¸€ï¼šé‡‘èç§‘æŠ€å­¦ä¹ ")
    st.info("æ­¤æ¨¡å—è®©AIå……å½“â€œäº’åŠ¨è®²å¸ˆ+å®éªŒæŒ‡å¯¼â€ï¼Œå¸®åŠ©ç”¨æˆ·ç†è§£æ ¸å¿ƒæœºåˆ¶ã€‚")

    st.subheader("é‡‘èç§‘æŠ€æ ¸å¿ƒæ¿å—")

    # 1. åˆ›å»ºè¡¨æ ¼æ•°æ® (æ¥è‡ª TPRD.pdf)
    learning_data = {
        "æ¿å— (Module)": [
            "æ”¯ä»˜ (Payment)",
            "å‚¨è“„ä¸å€Ÿè´· (Saving & Lending)",
            "ç­¹èµ„ (Financing)",
            "æŠ•èµ„ç®¡ç† (Investment Management)",
            "å¸‚åœºé¢„æµ‹ (Market Forecasting)"
        ],
        "å­¦ä¹ ä¸»é¢˜ (Topic)": [
            "æ•°å­—æ”¯ä»˜ç³»ç»Ÿã€è·¨å¢ƒæ”¯ä»˜ã€CBDC",
            "P2Pã€æ•°å­—ä¿¡è´·ã€å¾®è´·æ¨¡å‹",
            "ä¼—ç­¹ã€æ•°å­—å€ºåˆ¸ã€ä»£å¸å‘è¡Œ",
            "æŠ•èµ„ç»„åˆç†è®ºã€æœºå™¨äººé¡¾é—®",
            "æ•°æ®é©±åŠ¨é¢„æµ‹ã€é‡åŒ–æ¨¡å‹"
        ],
        "AI åŠ©æ‰‹æ¨¡æ‹Ÿ": [
            "AI è®²è§£æ”¯ä»˜ç³»ç»Ÿ",
            "AI è§£é‡Šé£æ§æ¨¡å‹",
            "AI æ¡ˆä¾‹åˆ†æ",
            "AI æ¨¡æ‹Ÿèµ„äº§é…ç½®",
            "AI å¸®åŠ©è¿è¡Œå›æµ‹"
        ]
    }

    df = pd.DataFrame(learning_data)

    # 2. åœ¨ç½‘é¡µä¸Šæ˜¾ç¤ºè¡¨æ ¼
    st.dataframe(df, use_container_width=True)

    st.markdown("---")

    # 3. ä¿ç•™AIè®²å¸ˆçš„èŠå¤©äº’åŠ¨åŠŸèƒ½
    st.subheader("AI äº’åŠ¨è®²å¸ˆ")
    st.chat_input("è¯·å‘AIè®²å¸ˆæé—® (ä¾‹å¦‚ï¼šä»€ä¹ˆæ˜¯P2Pï¼Ÿ)")


# ----------------- æ¨¡å—äºŒï¼šæŠ•ç ”å®éªŒå®¤ -----------------
elif page == "æ¨¡å—äºŒï¼šæŠ•ç ”å®éªŒå®¤ (Investment Lab)":
    st.title("ğŸ”¬ æ¨¡å—äºŒï¼šæŠ•ç ”å®éªŒå®¤")
    st.info("æ­¤æ¨¡å—æä¾›è™šæ‹ŸAIæŠ•ç ”å®éªŒå®¤ï¼Œç”¨äºæ„å»ºå’Œæµ‹è¯•æŠ•èµ„ç­–ç•¥ã€‚")

    # æ¨¡æ‹Ÿå®éªŒ1ï¼šç‰¹æ–¯æ‹‰ä¼°å€¼ (æ¥è‡ª TPRD.pdf)
    st.subheader("å®éªŒæ¡ˆä¾‹1ï¼šç‰¹æ–¯æ‹‰(TSLA)ä¼°å€¼æ˜¯å¦åˆç†ï¼Ÿ")
    if st.button("å¼€å§‹åŸºæœ¬é¢åˆ†æå®éªŒ"):
        with st.spinner("AIæ­£åœ¨æå–Teslaè´¢æŠ¥ (2020-2025) å¹¶ä¸Fordã€BYDå¯¹æ¯”..."):
            time.sleep(3)
            st.success("åˆ†æå®Œæˆï¼")
            st.markdown("#### æŠ•ç ”æŠ¥å‘Šï¼šã€ŠFundamental Valuation of Tesla (2020-2025)ã€‹")
            st.write("AIåˆ†æç»“è®ºï¼šHold (æ¨¡æ‹Ÿ)")

# ----------------- æ¨¡å—ä¸‰ï¼šAIä¼´éšåˆ†æ -----------------
elif page == "æ¨¡å—ä¸‰ï¼šAIä¼´éšåˆ†æ (AI Companion)":
    st.title("ğŸ¤ æ¨¡å—ä¸‰ï¼šAIä¼´éšåˆ†æ (AI Companion)")
    st.info("ä¸€ä¸ªâ€œæ‡‚é‡‘èç§‘æŠ€â€çš„æ™ºèƒ½AIåŠ©æ‰‹ï¼Œé€šè¿‡è‡ªç„¶è¯­è¨€ä¸æ‚¨ä¼´éšåˆ†æã€è§£é‡Šã€ç”ŸæˆæŠ¥å‘Šã€‚")

    default_query = "åˆ†æä¸€ä¸‹ ç‰¹æ–¯æ‹‰"
    query = st.text_area("è¯·è¾“å…¥ä½ çš„åˆ†æè¯·æ±‚:", value=default_query, height=100)

    if st.button("ğŸš€ å¼€å§‹åˆ†æ"):
        if query:
            # 1. â€¼ï¸â€¼ï¸ è°ƒç”¨çœŸå®çš„åç«¯ â€¼ï¸â€¼ï¸
            result = call_holistica_backend(query)

            # 2. æ˜¾ç¤ºåç«¯è¿”å›çš„æŠ¥å‘Š
            st.markdown("---")
            st.markdown(result["report"])

            # 3. â€¼ï¸â€¼ï¸ è§£æå¹¶æ˜¾ç¤ºåç«¯è¿”å›çš„å›¾è¡¨æ•°æ® â€¼ï¸â€¼ï¸
            # æ£€æŸ¥ 'data' é”®æ˜¯å¦å­˜åœ¨ï¼Œå¹¶ä¸”ä¸ä¸ºç©ºï¼Œå¹¶ä¸” 'price_history' é”®åœ¨ 'data' å†…éƒ¨
            if "data" in result and result["data"] and "price_history" in result["data"]:
                st.subheader("ç›¸å…³æ€§èµ°åŠ¿å›¾è¡¨ (æ¥è‡ªFastAPIçš„æ•°æ®)")

                # å°†åç«¯ä¼ æ¥çš„åˆ—è¡¨æ•°æ®è½¬ä¸º Pandas Series æ¥ç»˜å›¾
                price_data = result["data"]["price_history"]

                if price_data:  # ç¡®ä¿æ•°æ®åˆ—è¡¨ä¸ä¸ºç©º
                    chart_data_series = pd.Series(price_data)

                    fig, ax = plt.subplots()
                    chart_data_series.plot(ax=ax, grid=True, title=f"æ¨¡æ‹Ÿä»·æ ¼èµ°åŠ¿ (æ¥è‡ªåç«¯)")
                    ax.set_ylabel("Price (from Backend)")
                    plt.tight_layout()
                    st.pyplot(fig)
                else:
                    st.write("åç«¯è¿”å›äº†ç©ºçš„å›¾è¡¨æ•°æ®ã€‚")
            else:
                st.write("åç«¯æœªè¿”å›æœ‰æ•ˆçš„å›¾è¡¨æ•°æ®ã€‚")
        else:
            st.error("è¯·è¾“å…¥åˆ†æè¯·æ±‚ã€‚")

# ----------------- æ¨¡å—å››ï¼šå…¨çƒè¶‹åŠ¿ä¸æ–°é—» -----------------
elif page == "æ¨¡å—å››ï¼šå…¨çƒè¶‹åŠ¿ä¸æ–°é—» (News & Trends)":
    st.title("ğŸ“° æ¨¡å—å››ï¼šå…¨çƒè¶‹åŠ¿ä¸æ–°é—»")
    st.info("å®æ—¶è¿½è¸ªå…¨çƒé‡‘èç§‘æŠ€è¶‹åŠ¿ã€æœ€æ–°è´¢æŠ¥ä¸é»‘å¤©é¹…äº‹ä»¶ã€‚")
    st.subheader("å…¨çƒè´¢æŠ¥è¿½è¸ªä¸AIè§£è¯» (æ¨¡æ‹Ÿ)")
    st.markdown("""
    * **è‹¹æœ (AAPL)**: Q4 è´¢æŠ¥å‘å¸ƒï¼Œè¥æ”¶è¶…é¢„æœŸã€‚
    * **è‹±ä¼Ÿè¾¾ (NVDA)**: AIèŠ¯ç‰‡éœ€æ±‚æŒç»­å¼ºåŠ²ï¼ŒæŒ‡å¼•ä¸Šè°ƒã€‚
    """)
    st.subheader("é»‘å¤©é¹…ä¸“åŒº (æ¨¡æ‹Ÿ)")
    st.warning("çªå‘ï¼šæŸå¤§å‹èˆªè¿å…¬å¸å®£å¸ƒå› ä¸å¯æŠ—åŠ›æš‚åœçº¢æµ·èˆªçº¿ã€‚")