import setupTrackingContext from './lib/setupTrackingContext'
import processTailwindFeatures from './processTailwindFeatures'
import { env } from './lib/sharedState'
import { findAtConfigPath } from './lib/findAtConfigPath'

module.exports = function tailwindcss(configOrPath) {
  return {
    postcssPlugin: 'tailwindcss',
    plugins: [
      function (root, result) {
        const label = `JIT TOTAL ${Date.now()}-${Math.random().toString(36).slice(2, 6)}`
        result._tailwindTimerLabel = label

        if (env.DEBUG) {
          console.log('\n')
          try {
            console.time(label)
          } catch (error) {
            // Ignore timer setup issues in debug mode
          }
        }

        return root
      },
      async function (root, result) {
        configOrPath = findAtConfigPath(root, result) ?? configOrPath

        const context = setupTrackingContext(configOrPath)

        if (root.type === 'document') {
          const roots = root.nodes.filter((node) => node.type === 'root')

          for (const node of roots) {
            await processTailwindFeatures(context)(node, result)
          }

          return
        }

        await processTailwindFeatures(context)(root, result)
      },
      function (root, result) {
        const label = result._tailwindTimerLabel
        if (env.DEBUG && label) {
          try {
            console.timeEnd(label)
            console.log('\n')
          } catch (error) {
            // Ignore timer teardown issues in debug mode
          }
        }

        return root
      },
    ],
  }
}

module.exports.postcss = true
